<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GitWagon.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Git Wagon Provider</a> &gt; <a href="index.source.html" class="el_package">net.trajano.wagon.git</a> &gt; <span class="el_source">GitWagon.java</span></div><h1>GitWagon.java</h1><pre class="source lang-java linenums">package net.trajano.wagon.git;

import static java.lang.String.format;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.net.URISyntaxException;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.concurrent.ConcurrentHashMap;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.apache.maven.wagon.ConnectionException;
import org.apache.maven.wagon.InputData;
import org.apache.maven.wagon.OutputData;
import org.apache.maven.wagon.ResourceDoesNotExistException;
import org.apache.maven.wagon.StreamWagon;
import org.apache.maven.wagon.TransferFailedException;
import org.apache.maven.wagon.Wagon;
import org.apache.maven.wagon.authentication.AuthenticationException;
import org.apache.maven.wagon.authorization.AuthorizationException;
import org.codehaus.plexus.component.annotations.Component;
import org.codehaus.plexus.util.FileUtils;
import org.eclipse.jgit.api.Git;
import org.eclipse.jgit.api.errors.GitAPIException;
import org.eclipse.jgit.lib.Constants;
import org.eclipse.jgit.lib.RefUpdate;
import org.eclipse.jgit.transport.UsernamePasswordCredentialsProvider;

/**
 * Git Wagon. Due to issues with the way maven-site-plugin is improperly sending
 * requests that assume the target repository is a file system, the handling of
 * git URIs fails. This performs an inefficient, but working method of creating
 * a clone per request, but only once per Git repository.
 */
@Component(role = Wagon.class, hint = &quot;git&quot;, instantiationStrategy = &quot;per-lookup&quot;)
<span class="fc" id="L42">public class GitWagon extends StreamWagon {</span>

    /**
     * Logger.
     */
    private static final Logger LOG;

    /**
     * Messages resource path.
     */
    private static final String MESSAGES = &quot;META-INF/Messages&quot;;

    /**
     * Resource bundle.
     */
    private static final ResourceBundle R;

    static {
<span class="fc" id="L60">        LOG = Logger.getLogger(&quot;net.trajano.wagon.git&quot;, MESSAGES);</span>
<span class="fc" id="L61">        R = ResourceBundle.getBundle(MESSAGES);</span>
<span class="fc" id="L62">    }</span>

    /**
     * Credentials provider.
     */
    private UsernamePasswordCredentialsProvider credentialsProvider;

    /**
     * Git cache.
     */
<span class="fc" id="L72">    private final Map&lt;String, Git&gt; gitCache = new ConcurrentHashMap&lt;String, Git&gt;();</span>

    /**
     * Git URI.
     */
    private GitUri gitUri;

    /**
     * This will commit the local changes and push them to the repository. If
     * the method is unable to push to the repository without force, it will
     * throw an exception. {@inheritDoc}
     */
    @Override
    public void closeConnection() throws ConnectionException {
        try {
<span class="fc bfc" id="L87" title="All 2 branches covered.">            for (final String gitRemoteUri : gitCache.keySet()) {</span>
<span class="fc" id="L88">                final Git git = gitCache.get(gitRemoteUri);</span>
<span class="fc" id="L89">                git.add().addFilepattern(&quot;.&quot;).call(); //$NON-NLS-1$</span>
<span class="fc" id="L90">                git.commit().setMessage(R.getString(&quot;commitmessage&quot;)).call(); //$NON-NLS-1$</span>
<span class="fc" id="L91">                git.push().setRemote(gitRemoteUri)</span>
                        .setCredentialsProvider(credentialsProvider).call();
<span class="fc" id="L93">                git.close();</span>
<span class="fc" id="L94">                FileUtils.deleteDirectory(git.getRepository().getDirectory());</span>
<span class="fc" id="L95">            }</span>
<span class="nc" id="L96">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L97">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="nc" id="L98">        } catch (final IOException e) {</span>
<span class="nc" id="L99">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="fc" id="L100">        }</span>
<span class="fc" id="L101">    }</span>

    /**
     * This will read from the working copy. File modification date would not be
     * available as it does not really have any meaningful value. {@inheritDoc}
     * 
     * @throws ResourceDoesNotExistException
     *             when the file does not exist
     * @throws AuthorizationException
     *             when the file cannot be read
     */
    @Override
    public void fillInputData(final InputData inputData)
            throws TransferFailedException, ResourceDoesNotExistException,
            AuthorizationException {
        try {
<span class="fc" id="L117">            final File file = getFileForResource(inputData.getResource()</span>
                    .getName());
<span class="fc bfc" id="L119" title="All 2 branches covered.">            if (!file.exists()) {</span>
<span class="fc" id="L120">                throw new ResourceDoesNotExistException(format(</span>
                        R.getString(&quot;filenotfound&quot;), file)); //$NON-NLS-1$
            }
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">            if (!file.canRead()) {</span>
<span class="nc" id="L124">                throw new AuthorizationException(format(</span>
                        R.getString(&quot;cannotreadfile&quot;), file)); //$NON-NLS-1$
            }
<span class="fc" id="L127">            inputData.setInputStream(new FileInputStream(file));</span>
<span class="fc" id="L128">            inputData.getResource().setContentLength(file.length());</span>
<span class="nc" id="L129">        } catch (final IOException e) {</span>
<span class="nc" id="L130">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L131">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L132">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L133">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L134">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L135">        }</span>
<span class="fc" id="L136">    }</span>

    /**
     * This will write to the working copy. {@inheritDoc}
     */
    @Override
    public void fillOutputData(final OutputData outputData)
            throws TransferFailedException {
        try {
<span class="fc" id="L145">            final File file = getFileForResource(outputData.getResource()</span>
                    .getName());
<span class="pc bpc" id="L147" title="1 of 4 branches missed.">            if (!file.getParentFile().mkdirs()</span>
                    &amp;&amp; !file.getParentFile().exists()) {
<span class="nc" id="L149">                throw new TransferFailedException(format(</span>
                        R.getString(&quot;unabletocreatedirs&quot;), //$NON-NLS-1$
                        file.getParentFile()));
            }
<span class="fc" id="L153">            outputData.setOutputStream(new FileOutputStream(file));</span>
<span class="fc" id="L154">        } catch (final IOException e) {</span>
<span class="fc" id="L155">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L156">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L157">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L158">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L159">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L160">        }</span>
<span class="fc" id="L161">    }</span>

    /**
     * This will get the file object for the given resource relative to the
     * {@link Git} specified for the connection. It will handle resources where
     * it jumps up past the parent folder.
     * 
     * @param resourceName
     *            resource name.
     * @return file used for the resourse.
     * @throws IOException
     * @throws GitAPIException
     * @throws URISyntaxException
     */
    private File getFileForResource(final String resourceName)
            throws GitAPIException, IOException, URISyntaxException {
        // /foo/bar/foo.git + ../bar.git == /foo/bar/bar.git + /
        // /foo/bar/foo.git + ../bar.git/abc == /foo/bar/bar.git + /abc
<span class="fc" id="L179">        final GitUri resolved = gitUri.resolve(resourceName);</span>
<span class="fc" id="L180">        final Git resourceGit = getGit(resolved.getGitRepositoryUri());</span>
<span class="fc" id="L181">        return new File(resourceGit.getRepository().getWorkTree(),</span>
                resolved.getResource());
    }

    /**
     * {@inheritDoc}
     * &lt;p&gt;
     * Warnings are suppressed for false positive with Sonar and multiple
     * exceptions on public API. {@inheritDoc}
     * &lt;/p&gt;
     */
    @Override
    @SuppressWarnings(&quot;all&quot;)
    public List&lt;String&gt; getFileList(final String directory)
            throws TransferFailedException, ResourceDoesNotExistException,
            AuthorizationException {
        final File dir;
        try {
<span class="fc" id="L199">            dir = getFileForResource(directory);</span>
<span class="nc" id="L200">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L201">            throw new AuthorizationException(e.getMessage(), e);</span>
<span class="nc" id="L202">        } catch (final IOException e) {</span>
<span class="nc" id="L203">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L204">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L205">            throw new ResourceDoesNotExistException(e.getMessage(), e);</span>
<span class="fc" id="L206">        }</span>
<span class="fc" id="L207">        final File[] files = dir.listFiles();</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">        if (files == null) {</span>
<span class="fc" id="L209">            throw new ResourceDoesNotExistException(format(</span>
                    R.getString(&quot;dirnotfound&quot;), dir)); //$NON-NLS-1$
        }
<span class="fc" id="L212">        final List&lt;String&gt; list = new LinkedList&lt;String&gt;();</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        for (final File file : files) {</span>
<span class="fc" id="L214">            String name = file.getName();</span>
<span class="pc bpc" id="L215" title="1 of 4 branches missed.">            if (file.isDirectory() &amp;&amp; !name.endsWith(&quot;/&quot;)) { //$NON-NLS-1$</span>
<span class="fc" id="L216">                name += &quot;/&quot;; // NOPMD this is easier to read. //$NON-NLS-1$</span>
            }
<span class="fc" id="L218">            list.add(name);</span>
        }
<span class="fc" id="L220">        return list;</span>
    }

    /**
     * This will create or refresh the working copy. If the working copy cannot
     * be pulled cleanly this method will fail.
     * 
     * @param gitRepositoryUri
     *            remote git repository URI string
     * @return git
     * @throws GitAPIException
     * @throws IOException
     * @throws URISyntaxException
     */
    private Git getGit(final String gitRepositoryUri) throws GitAPIException,
            IOException, URISyntaxException {
<span class="fc" id="L236">        final Git cachedGit = gitCache.get(gitRepositoryUri);</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (cachedGit != null) {</span>
<span class="fc" id="L238">            return cachedGit;</span>
        }
<span class="fc" id="L240">        final File gitDir = File.createTempFile(</span>
                gitRepositoryUri.replaceAll(&quot;[^A-Za-z]&quot;, &quot;_&quot;), &quot;wagon-git&quot;); //$NON-NLS-1$
<span class="fc" id="L242">        gitDir.delete();</span>
<span class="fc" id="L243">        gitDir.mkdir();</span>

<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        credentialsProvider = new UsernamePasswordCredentialsProvider(</span>
                getAuthenticationInfo().getUserName(), getAuthenticationInfo()
                        .getPassword() == null ? &quot;&quot; //$NON-NLS-1$
                        : getAuthenticationInfo().getPassword());
<span class="fc" id="L249">        final Git git = Git.cloneRepository().setURI(gitRepositoryUri)</span>
                .setCredentialsProvider(credentialsProvider)
                .setBranch(gitUri.getBranchName()).setDirectory(gitDir).call();
<span class="fc bfc" id="L252" title="All 2 branches covered.">        if (!gitUri.getBranchName().equals(git.getRepository().getBranch())) {</span>
<span class="fc" id="L253">            LOG.log(Level.INFO, &quot;missingbranch&quot;, gitUri.getBranchName());</span>
<span class="fc" id="L254">            final RefUpdate refUpdate = git.getRepository().getRefDatabase()</span>
                    .newUpdate(Constants.HEAD, true);
<span class="fc" id="L256">            refUpdate.setForceUpdate(true);</span>
<span class="fc" id="L257">            refUpdate.link(&quot;refs/heads/&quot; + gitUri.getBranchName()); //$NON-NLS-1$</span>
        }
<span class="fc" id="L259">        gitCache.put(gitRepositoryUri, git);</span>
<span class="fc" id="L260">        return git;</span>
    }

    /**
     * Sets the initial git URI.
     */
    @Override
    protected void openConnectionInternal() throws ConnectionException,
            AuthenticationException {
        try {
<span class="fc" id="L270">            gitUri = new GitUri(getRepository().getUrl());</span>
<span class="nc" id="L271">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L272">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="fc" id="L273">        }</span>
<span class="fc" id="L274">    }</span>

    /**
     * If the destination directory is not inside the source directory (denoted
     * by starting with &quot;../&quot;), then another git repository is registered.
     * Warnings are suppressed for false positive with Sonar and multiple
     * exceptions on public API. {@inheritDoc}
     */
    @Override
    @SuppressWarnings(&quot;all&quot;)
    public void putDirectory(final File sourceDirectory,
            final String destinationDirectory) throws TransferFailedException,
            ResourceDoesNotExistException, AuthorizationException {
        try {
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">            if (!sourceDirectory.isDirectory()) {</span>
<span class="nc" id="L289">                throw new ResourceDoesNotExistException(format(</span>
                        R.getString(&quot;dirnotfound&quot;), sourceDirectory)); //$NON-NLS-1$
            }
<span class="fc" id="L292">            final File fileForResource = getFileForResource(destinationDirectory);</span>
<span class="fc" id="L293">            FileUtils.copyDirectoryStructure(sourceDirectory, fileForResource);</span>
<span class="nc" id="L294">        } catch (final IOException e) {</span>
<span class="nc" id="L295">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L296">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L297">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L298">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L299">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L300">        }</span>
<span class="fc" id="L301">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean resourceExists(final String resourceName)
            throws TransferFailedException {
        final File file;
        try {
<span class="fc" id="L311">            file = getFileForResource(resourceName);</span>
<span class="nc" id="L312">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L313">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L314">        } catch (final IOException e) {</span>
<span class="nc" id="L315">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L316">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L317">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L318">        }</span>

<span class="pc bpc" id="L320" title="1 of 2 branches missed.">        if (resourceName.endsWith(&quot;/&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L321">            return file.isDirectory();</span>
        }

<span class="fc" id="L324">        return file.exists();</span>
    }

    /**
     * Directory copy is supported.
     * 
     * @return true
     */
    @Override
    public boolean supportsDirectoryCopy() {
<span class="fc" id="L334">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312101107</span></div></body></html>