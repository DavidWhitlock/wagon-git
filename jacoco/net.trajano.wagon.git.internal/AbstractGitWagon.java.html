<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractGitWagon.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Git Wagon Provider</a> &gt; <a href="index.source.html" class="el_package">net.trajano.wagon.git.internal</a> &gt; <span class="el_source">AbstractGitWagon.java</span></div><h1>AbstractGitWagon.java</h1><pre class="source lang-java linenums">package net.trajano.wagon.git.internal;

import static java.lang.String.format;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.net.URISyntaxException;
import java.util.LinkedList;
import java.util.List;
import java.util.ResourceBundle;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.apache.maven.wagon.ConnectionException;
import org.apache.maven.wagon.InputData;
import org.apache.maven.wagon.OutputData;
import org.apache.maven.wagon.ResourceDoesNotExistException;
import org.apache.maven.wagon.StreamWagon;
import org.apache.maven.wagon.TransferFailedException;
import org.apache.maven.wagon.authentication.AuthenticationException;
import org.apache.maven.wagon.authorization.AuthorizationException;
import org.codehaus.plexus.util.FileUtils;
import org.eclipse.jgit.api.Git;
import org.eclipse.jgit.api.errors.GitAPIException;
import org.eclipse.jgit.lib.Constants;
import org.eclipse.jgit.lib.RefUpdate;
import org.eclipse.jgit.transport.CredentialsProvider;
import org.eclipse.jgit.transport.UsernamePasswordCredentialsProvider;

/**
 * Common parts of handling Git based repositories.
 */
<span class="fc" id="L37">public abstract class AbstractGitWagon extends StreamWagon {</span>

    /**
     * Logger.
     */
    private static final Logger LOG;

    /**
     * Messages resource path.
     */
    private static final String MESSAGES = &quot;META-INF/Messages&quot;;

    /**
     * Resource bundle.
     */
    private static final ResourceBundle R;

    static {
<span class="fc" id="L55">        LOG = Logger.getLogger(&quot;net.trajano.wagon.git&quot;, MESSAGES);</span>
<span class="fc" id="L56">        R = ResourceBundle.getBundle(MESSAGES);</span>
<span class="fc" id="L57">    }</span>

    /**
     * Credentials provider.
     */
    private CredentialsProvider credentialsProvider;

    /**
     * Git cache.
     */
<span class="fc" id="L67">    private final ConcurrentMap&lt;String, Git&gt; gitCache = new ConcurrentHashMap&lt;String, Git&gt;();</span>

    /**
     * Git URI.
     */
    private GitUri gitUri;

    /**
     * Builds the wagon specific Git URI based on the repository URL. This is
     * made public rather than protected to allow testing of the method.
     *
     * @param repositoryUrl
     *            repository URL
     * @return Git URI
     * @throws ConnectionException
     *             problem when connecting
     * @throws AuthenticationException
     *             problem with authentication
     */
    public abstract GitUri buildGitUri(String repositoryUrl)
            throws ConnectionException, AuthenticationException;

    /**
     * This will commit the local changes and push them to the repository. If
     * the method is unable to push to the repository without force, it will
     * throw an exception. {@inheritDoc}
     */
    @Override
    public void closeConnection() throws ConnectionException {
        try {
<span class="fc bfc" id="L97" title="All 2 branches covered.">            for (final String gitRemoteUri : gitCache.keySet()) {</span>
<span class="fc" id="L98">                final Git git = gitCache.get(gitRemoteUri);</span>
<span class="fc" id="L99">                git.add().addFilepattern(&quot;.&quot;).call(); //$NON-NLS-1$</span>
<span class="fc" id="L100">                git.commit().setMessage(R.getString(&quot;commitmessage&quot;)).call(); //$NON-NLS-1$</span>
<span class="fc" id="L101">                git.push().setRemote(gitRemoteUri)</span>
<span class="fc" id="L102">                .setCredentialsProvider(credentialsProvider).call();</span>
<span class="fc" id="L103">                git.close();</span>
<span class="fc" id="L104">                FileUtils.deleteDirectory(git.getRepository().getDirectory());</span>
<span class="fc" id="L105">            }</span>
<span class="nc" id="L106">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L107">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="nc" id="L108">        } catch (final IOException e) {</span>
<span class="nc" id="L109">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="fc" id="L110">        }</span>
<span class="fc" id="L111">    }</span>

    /**
     * This will read from the working copy. File modification date would not be
     * available as it does not really have any meaningful value. {@inheritDoc}
     *
     * @throws ResourceDoesNotExistException
     *             when the file does not exist
     * @throws AuthorizationException
     *             when the file cannot be read
     */
    @Override
    public void fillInputData(final InputData inputData)
            throws TransferFailedException, ResourceDoesNotExistException,
            AuthorizationException {
        try {
<span class="fc" id="L127">            final File file = getFileForResource(inputData.getResource()</span>
<span class="fc" id="L128">                    .getName());</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">            if (!file.exists()) {</span>
<span class="fc" id="L130">                throw new ResourceDoesNotExistException(format(</span>
<span class="fc" id="L131">                        R.getString(&quot;filenotfound&quot;), file)); //$NON-NLS-1$</span>
            }
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">            if (!file.canRead()) {</span>
<span class="nc" id="L134">                throw new AuthorizationException(format(</span>
<span class="nc" id="L135">                        R.getString(&quot;cannotreadfile&quot;), file)); //$NON-NLS-1$</span>
            }
<span class="fc" id="L137">            inputData.setInputStream(new FileInputStream(file));</span>
<span class="fc" id="L138">            inputData.getResource().setContentLength(file.length());</span>
<span class="nc" id="L139">        } catch (final IOException e) {</span>
<span class="nc" id="L140">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L141">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L142">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L143">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L144">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L145">        }</span>
<span class="fc" id="L146">    }</span>

    /**
     * This will write to the working copy. {@inheritDoc}
     */
    @Override
    public void fillOutputData(final OutputData outputData)
            throws TransferFailedException {
        try {
<span class="fc" id="L155">            final File file = getFileForResource(outputData.getResource()</span>
<span class="fc" id="L156">                    .getName());</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">            if (!file.getParentFile().mkdirs()</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">                    &amp;&amp; !file.getParentFile().exists()) {</span>
<span class="nc" id="L159">                throw new TransferFailedException(format(</span>
<span class="nc" id="L160">                        R.getString(&quot;unabletocreatedirs&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L161">                        file.getParentFile()));</span>
            }
<span class="fc" id="L163">            outputData.setOutputStream(new FileOutputStream(file));</span>
<span class="fc" id="L164">        } catch (final IOException e) {</span>
<span class="fc" id="L165">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L166">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L167">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L168">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L169">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L170">        }</span>
<span class="fc" id="L171">    }</span>

    /**
     * This will get the file object for the given resource relative to the
     * {@link Git} specified for the connection. It will handle resources where
     * it jumps up past the parent folder.
     *
     * @param resourceName
     *            resource name.
     * @return file used for the resource.
     * @throws IOException
     * @throws GitAPIException
     *             problem with the GIT API.
     * @throws URISyntaxException
     */
    private File getFileForResource(final String resourceName)
            throws GitAPIException, IOException, URISyntaxException {
        // /foo/bar/foo.git + ../bar.git == /foo/bar/bar.git + /
        // /foo/bar/foo.git + ../bar.git/abc == /foo/bar/bar.git + /abc
<span class="fc" id="L190">        final GitUri resolved = gitUri.resolve(resourceName);</span>
<span class="fc" id="L191">        final Git resourceGit = getGit(resolved.getGitRepositoryUri());</span>
<span class="fc" id="L192">        return new File(resourceGit.getRepository().getWorkTree(),</span>
<span class="fc" id="L193">                resolved.getResource());</span>
    }

    /**
     * {@inheritDoc}
     * &lt;p&gt;
     * Warnings are suppressed for false positive with Sonar and multiple
     * exceptions on public API. {@inheritDoc}
     * &lt;/p&gt;
     */
    @Override
    @SuppressWarnings(&quot;all&quot;)
    public List&lt;String&gt; getFileList(final String directory)
            throws TransferFailedException, ResourceDoesNotExistException,
            AuthorizationException {
        final File dir;
        try {
<span class="fc" id="L210">            dir = getFileForResource(directory);</span>
<span class="nc" id="L211">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L212">            throw new AuthorizationException(e.getMessage(), e);</span>
<span class="nc" id="L213">        } catch (final IOException e) {</span>
<span class="nc" id="L214">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L215">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L216">            throw new ResourceDoesNotExistException(e.getMessage(), e);</span>
<span class="fc" id="L217">        }</span>
<span class="fc" id="L218">        final File[] files = dir.listFiles();</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">        if (files == null) {</span>
<span class="fc" id="L220">            throw new ResourceDoesNotExistException(format(</span>
<span class="fc" id="L221">                    R.getString(&quot;dirnotfound&quot;), dir)); //$NON-NLS-1$</span>
        }
<span class="fc" id="L223">        final List&lt;String&gt; list = new LinkedList&lt;String&gt;();</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">        for (final File file : files) {</span>
<span class="fc" id="L225">            String name = file.getName();</span>
<span class="pc bpc" id="L226" title="1 of 4 branches missed.">            if (file.isDirectory() &amp;&amp; !name.endsWith(&quot;/&quot;)) { //$NON-NLS-1$</span>
<span class="fc" id="L227">                name += &quot;/&quot;; // NOPMD this is easier to read. //$NON-NLS-1$</span>
            }
<span class="fc" id="L229">            list.add(name);</span>
        }
<span class="fc" id="L231">        return list;</span>
    }

    /**
     * This will create or refresh the working copy. If the working copy cannot
     * be pulled cleanly this method will fail.
     *
     * @param gitRepositoryUri
     *            remote git repository URI string
     * @return git
     * @throws GitAPIException
     * @throws IOException
     * @throws URISyntaxException
     */
    private Git getGit(final String gitRepositoryUri) throws GitAPIException,
    IOException, URISyntaxException {
<span class="fc" id="L247">        final Git cachedGit = gitCache.get(gitRepositoryUri);</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (cachedGit != null) {</span>
<span class="fc" id="L249">            return cachedGit;</span>
        }
<span class="fc" id="L251">        final File gitDir = File.createTempFile(</span>
<span class="fc" id="L252">                gitRepositoryUri.replaceAll(&quot;[^A-Za-z]&quot;, &quot;_&quot;), &quot;wagon-git&quot;); //$NON-NLS-1$</span>
<span class="fc" id="L253">        gitDir.delete();</span>
<span class="fc" id="L254">        gitDir.mkdir();</span>

<span class="pc bpc" id="L256" title="1 of 2 branches missed.">        if (getAuthenticationInfo().getUserName() != null) {</span>
<span class="nc" id="L257">            credentialsProvider = new UsernamePasswordCredentialsProvider(</span>
<span class="nc" id="L258">                    getAuthenticationInfo().getUserName(),</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                    getAuthenticationInfo().getPassword() == null ? &quot;&quot; //$NON-NLS-1$</span>
<span class="nc" id="L260">                            : getAuthenticationInfo().getPassword());</span>
        } else {
<span class="fc" id="L262">            credentialsProvider = new PassphraseCredentialsProvider(</span>
<span class="fc" id="L263">                    getAuthenticationInfo().getPassword());</span>
        }
<span class="fc" id="L265">        final Git git = Git.cloneRepository().setURI(gitRepositoryUri)</span>
<span class="fc" id="L266">                .setCredentialsProvider(credentialsProvider)</span>
<span class="fc" id="L267">                .setBranch(gitUri.getBranchName()).setDirectory(gitDir).call();</span>
<span class="fc bfc" id="L268" title="All 2 branches covered.">        if (!gitUri.getBranchName().equals(git.getRepository().getBranch())) {</span>
<span class="fc" id="L269">            LOG.log(Level.INFO, &quot;missingbranch&quot;, gitUri.getBranchName());</span>
<span class="fc" id="L270">            final RefUpdate refUpdate = git.getRepository().getRefDatabase()</span>
<span class="fc" id="L271">                    .newUpdate(Constants.HEAD, true);</span>
<span class="fc" id="L272">            refUpdate.setForceUpdate(true);</span>
<span class="fc" id="L273">            refUpdate.link(&quot;refs/heads/&quot; + gitUri.getBranchName()); //$NON-NLS-1$</span>
        }
<span class="fc" id="L275">        gitCache.put(gitRepositoryUri, git);</span>
<span class="fc" id="L276">        return git;</span>
    }

    /**
     * Sets the initial git URI.
     */
    @Override
    protected void openConnectionInternal() throws ConnectionException,
    AuthenticationException {
<span class="fc" id="L285">        gitUri = buildGitUri(getRepository().getUrl());</span>
<span class="fc" id="L286">    }</span>

    /**
     * If the destination directory is not inside the source directory (denoted
     * by starting with &quot;../&quot;), then another git repository is registered.
     * Warnings are suppressed for false positive with Sonar and multiple
     * exceptions on public API. {@inheritDoc}
     */
    @Override
    @SuppressWarnings(&quot;all&quot;)
    public void putDirectory(final File sourceDirectory,
            final String destinationDirectory) throws TransferFailedException,
            ResourceDoesNotExistException, AuthorizationException {
        try {
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">            if (!sourceDirectory.isDirectory()) {</span>
<span class="nc" id="L301">                throw new ResourceDoesNotExistException(format(</span>
<span class="nc" id="L302">                        R.getString(&quot;dirnotfound&quot;), sourceDirectory)); //$NON-NLS-1$</span>
            }
<span class="fc" id="L304">            final File fileForResource = getFileForResource(destinationDirectory);</span>
<span class="fc" id="L305">            FileUtils.copyDirectoryStructure(sourceDirectory, fileForResource);</span>
<span class="nc" id="L306">        } catch (final IOException e) {</span>
<span class="nc" id="L307">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L308">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L309">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L310">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L311">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L312">        }</span>
<span class="fc" id="L313">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean resourceExists(final String resourceName)
            throws TransferFailedException {
        final File file;
        try {
<span class="fc" id="L323">            file = getFileForResource(resourceName);</span>
<span class="nc" id="L324">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L325">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L326">        } catch (final IOException e) {</span>
<span class="nc" id="L327">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L328">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L329">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L330">        }</span>

<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (resourceName.endsWith(&quot;/&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L333">            return file.isDirectory();</span>
        }

<span class="fc" id="L336">        return file.exists();</span>
    }

    /**
     * Directory copy is supported.
     *
     * @return true
     */
    @Override
    public boolean supportsDirectoryCopy() {
<span class="fc" id="L346">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.0.201403182114</span></div></body></html>