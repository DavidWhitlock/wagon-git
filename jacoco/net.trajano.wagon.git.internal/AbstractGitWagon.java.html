<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractGitWagon.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Git Wagon Provider</a> &gt; <a href="index.source.html" class="el_package">net.trajano.wagon.git.internal</a> &gt; <span class="el_source">AbstractGitWagon.java</span></div><h1>AbstractGitWagon.java</h1><pre class="source lang-java linenums">package net.trajano.wagon.git.internal;

import static java.lang.String.format;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.util.LinkedList;
import java.util.List;
import java.util.ResourceBundle;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.apache.maven.wagon.ConnectionException;
import org.apache.maven.wagon.InputData;
import org.apache.maven.wagon.OutputData;
import org.apache.maven.wagon.ResourceDoesNotExistException;
import org.apache.maven.wagon.StreamWagon;
import org.apache.maven.wagon.TransferFailedException;
import org.apache.maven.wagon.authentication.AuthenticationException;
import org.apache.maven.wagon.authorization.AuthorizationException;
import org.codehaus.plexus.util.FileUtils;
import org.eclipse.jgit.api.Git;
import org.eclipse.jgit.api.errors.GitAPIException;
import org.eclipse.jgit.api.errors.InvalidRemoteException;
import org.eclipse.jgit.errors.NoRemoteRepositoryException;
import org.eclipse.jgit.lib.Constants;
import org.eclipse.jgit.lib.RefUpdate;
import org.eclipse.jgit.transport.CredentialsProvider;
import org.eclipse.jgit.transport.UsernamePasswordCredentialsProvider;

/**
 * Common parts of handling Git based repositories.
 */
<span class="fc" id="L40">public abstract class AbstractGitWagon extends StreamWagon {</span>

    /**
     * Logger.
     */
    private static final Logger LOG;

    /**
     * Messages resource path.
     */
    private static final String MESSAGES = &quot;META-INF/Messages&quot;;

    /**
     * Resource bundle.
     */
    private static final ResourceBundle R;

    static {
<span class="fc" id="L58">        LOG = Logger.getLogger(&quot;net.trajano.wagon.git&quot;, MESSAGES);</span>
<span class="fc" id="L59">        R = ResourceBundle.getBundle(MESSAGES);</span>
<span class="fc" id="L60">    }</span>

    /**
     * Credentials provider.
     */
    private CredentialsProvider credentialsProvider;

    /**
     * Git cache.
     */
<span class="fc" id="L70">    private final ConcurrentMap&lt;String, Git&gt; gitCache = new ConcurrentHashMap&lt;String, Git&gt;();</span>

    /**
     * Git URI.
     */
    private GitUri gitUri;

    /**
     * Builds the wagon specific Git URI based on the repository URL. This is
     * made public rather than protected to allow testing of the method.
     *
     * @param repositoryUrl
     *            repository URL
     * @return Git URI
     * @throws IOException
     * @throws URISyntaxException
     */
    public abstract GitUri buildGitUri(URI repositoryUrl) throws IOException,
    URISyntaxException;

    /**
     * This will commit the local changes and push them to the repository. If
     * the method is unable to push to the repository without force, it will
     * throw an exception. {@inheritDoc}
     */
    @Override
    public void closeConnection() throws ConnectionException {
        try {
<span class="fc bfc" id="L98" title="All 2 branches covered.">            for (final String gitRemoteUri : gitCache.keySet()) {</span>
<span class="fc" id="L99">                final Git git = gitCache.get(gitRemoteUri);</span>
<span class="fc" id="L100">                git.add().addFilepattern(&quot;.&quot;).call(); //$NON-NLS-1$</span>
<span class="fc" id="L101">                git.commit().setMessage(R.getString(&quot;commitmessage&quot;)).call(); //$NON-NLS-1$</span>
<span class="fc" id="L102">                git.push().setRemote(gitRemoteUri)</span>
                        .setCredentialsProvider(credentialsProvider).call();
<span class="fc" id="L104">                git.close();</span>
<span class="fc" id="L105">                FileUtils.deleteDirectory(git.getRepository().getDirectory());</span>
<span class="fc" id="L106">            }</span>
<span class="nc" id="L107">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L108">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="nc" id="L109">        } catch (final IOException e) {</span>
<span class="nc" id="L110">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="fc" id="L111">        }</span>
<span class="fc" id="L112">    }</span>

    /**
     * This will read from the working copy. File modification date would not be
     * available as it does not really have any meaningful value. {@inheritDoc}
     *
     * @throws ResourceDoesNotExistException
     *             when the file does not exist
     * @throws AuthorizationException
     *             when the file cannot be read
     */
    @Override
    public void fillInputData(final InputData inputData)
            throws TransferFailedException, ResourceDoesNotExistException,
            AuthorizationException {
        try {
<span class="fc" id="L128">            final File file = getFileForResource(inputData.getResource()</span>
                    .getName());
<span class="fc bfc" id="L130" title="All 2 branches covered.">            if (!file.exists()) {</span>
<span class="fc" id="L131">                throw new ResourceDoesNotExistException(format(</span>
                        R.getString(&quot;filenotfound&quot;), file)); //$NON-NLS-1$
            }
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">            if (!file.canRead()) {</span>
<span class="nc" id="L135">                throw new AuthorizationException(format(</span>
                        R.getString(&quot;cannotreadfile&quot;), file)); //$NON-NLS-1$
            }
<span class="fc" id="L138">            inputData.setInputStream(new FileInputStream(file));</span>
<span class="fc" id="L139">            inputData.getResource().setContentLength(file.length());</span>
<span class="nc" id="L140">        } catch (final IOException e) {</span>
<span class="nc" id="L141">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L142">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L143">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L144">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L145">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L146">        }</span>
<span class="fc" id="L147">    }</span>

    /**
     * This will write to the working copy. {@inheritDoc}
     */
    @Override
    public void fillOutputData(final OutputData outputData)
            throws TransferFailedException {
        try {
<span class="fc" id="L156">            final File file = getFileForResource(outputData.getResource()</span>
                    .getName());
<span class="pc bpc" id="L158" title="1 of 4 branches missed.">            if (!file.getParentFile().mkdirs()</span>
                    &amp;&amp; !file.getParentFile().exists()) {
<span class="nc" id="L160">                throw new TransferFailedException(format(</span>
                        R.getString(&quot;unabletocreatedirs&quot;), //$NON-NLS-1$
                        file.getParentFile()));
            }
<span class="fc" id="L164">            outputData.setOutputStream(new FileOutputStream(file));</span>
<span class="fc" id="L165">        } catch (final IOException e) {</span>
<span class="fc" id="L166">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L167">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L168">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L169">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L170">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L171">        }</span>
<span class="fc" id="L172">    }</span>

    /**
     * This will get the file object for the given resource relative to the
     * {@link Git} specified for the connection. It will handle resources where
     * it jumps up past the parent folder.
     *
     * @param resourceName
     *            resource name.
     * @return file used for the resource.
     * @throws IOException
     * @throws GitAPIException
     *             problem with the GIT API.
     * @throws URISyntaxException
     * @throws ResourceDoesNotExistException
     */
    protected abstract File getFileForResource(String resourceName)
            throws GitAPIException, IOException, URISyntaxException;

    /**
     * {@inheritDoc}
     * &lt;p&gt;
     * Warnings are suppressed for false positive with Sonar and multiple
     * exceptions on public API. {@inheritDoc}
     * &lt;/p&gt;
     */
    @Override
    @SuppressWarnings(&quot;all&quot;)
    public List&lt;String&gt; getFileList(final String directory)
            throws TransferFailedException, ResourceDoesNotExistException,
            AuthorizationException {
        final File dir;
        try {
<span class="fc" id="L205">            dir = getFileForResource(directory);</span>
<span class="nc" id="L206">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L207">            throw new AuthorizationException(e.getMessage(), e);</span>
<span class="nc" id="L208">        } catch (final IOException e) {</span>
<span class="nc" id="L209">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L210">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L211">            throw new ResourceDoesNotExistException(e.getMessage(), e);</span>
<span class="fc" id="L212">        }</span>
<span class="fc" id="L213">        final File[] files = dir.listFiles();</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">        if (files == null) {</span>
<span class="fc" id="L215">            throw new ResourceDoesNotExistException(format(</span>
                    R.getString(&quot;dirnotfound&quot;), dir)); //$NON-NLS-1$
        }
<span class="fc" id="L218">        final List&lt;String&gt; list = new LinkedList&lt;String&gt;();</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">        for (final File file : files) {</span>
<span class="fc" id="L220">            String name = file.getName();</span>
<span class="pc bpc" id="L221" title="1 of 4 branches missed.">            if (file.isDirectory() &amp;&amp; !name.endsWith(&quot;/&quot;)) { //$NON-NLS-1$</span>
<span class="fc" id="L222">                name += &quot;/&quot;; // NOPMD this is easier to read. //$NON-NLS-1$</span>
            }
<span class="fc" id="L224">            list.add(name);</span>
        }
<span class="fc" id="L226">        return list;</span>
    }

    /**
     * This will create or refresh the working copy. If the working copy cannot
     * be pulled cleanly this method will fail.
     *
     * @param gitRepositoryUri
     *            remote git repository URI string
     * @return git
     * @throws GitAPIException
     * @throws IOException
     * @throws URISyntaxException
     * @thorws ResourceDoesNotExistException remote repository does not exist.
     */
    protected Git getGit(final String gitRepositoryUri) throws GitAPIException,
            IOException, URISyntaxException, ResourceDoesNotExistException {
<span class="fc" id="L243">        final Git cachedGit = gitCache.get(gitRepositoryUri);</span>
<span class="fc" id="L244">        LOG.fine(&quot;Loading &quot; + gitRepositoryUri);</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">        if (cachedGit != null) {</span>
<span class="fc" id="L246">            return cachedGit;</span>
        }
<span class="fc" id="L248">        final File gitDir = File.createTempFile(</span>
                gitRepositoryUri.replaceAll(&quot;[^A-Za-z]&quot;, &quot;_&quot;), &quot;wagon-git&quot;); //$NON-NLS-1$
<span class="fc" id="L250">        gitDir.delete();</span>
<span class="fc" id="L251">        gitDir.mkdir();</span>

<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        if (getAuthenticationInfo().getUserName() != null) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            credentialsProvider = new UsernamePasswordCredentialsProvider(</span>
                    getAuthenticationInfo().getUserName(),
                    getAuthenticationInfo().getPassword() == null ? &quot;&quot; //$NON-NLS-1$
                            : getAuthenticationInfo().getPassword());
        } else {
<span class="fc" id="L259">            credentialsProvider = new PassphraseCredentialsProvider(</span>
                    getAuthenticationInfo().getPassword());
        }
        try {
<span class="fc" id="L263">            final Git git = Git.cloneRepository().setURI(gitRepositoryUri)</span>
                    .setCredentialsProvider(credentialsProvider)
                    .setBranch(gitUri.getBranchName()).setDirectory(gitDir)
                    .call();
<span class="fc bfc" id="L267" title="All 2 branches covered.">            if (!gitUri.getBranchName().equals(git.getRepository().getBranch())) {</span>
<span class="fc" id="L268">                LOG.log(Level.INFO, &quot;missingbranch&quot;, gitUri.getBranchName());</span>
<span class="fc" id="L269">                final RefUpdate refUpdate = git.getRepository()</span>
                        .getRefDatabase().newUpdate(Constants.HEAD, true);
<span class="fc" id="L271">                refUpdate.setForceUpdate(true);</span>
<span class="fc" id="L272">                refUpdate.link(&quot;refs/heads/&quot; + gitUri.getBranchName()); //$NON-NLS-1$</span>
            }
<span class="fc" id="L274">            gitCache.put(gitRepositoryUri, git);</span>
<span class="fc" id="L275">            return git;</span>
<span class="nc" id="L276">        } catch (final InvalidRemoteException e) {</span>
<span class="nc" id="L277">            throw new ResourceDoesNotExistException(e.getMessage(), e);</span>
<span class="nc" id="L278">        } catch (final NoRemoteRepositoryException e) {</span>
<span class="nc" id="L279">            throw new ResourceDoesNotExistException(e.getMessage(), e);</span>
        }
    }

    protected GitUri getGitUri() {
<span class="fc" id="L284">        return gitUri;</span>
    }

    /**
     * Sets the initial git URI.
     */
    @Override
    protected void openConnectionInternal() throws ConnectionException,
    AuthenticationException {
        URI uri;
        try {
<span class="fc" id="L295">            uri = new URI(</span>
                    new URI(getRepository().getUrl().replace(&quot;##&quot;, &quot;#&quot;))
                    .getSchemeSpecificPart()).normalize();
<span class="fc" id="L298">            gitUri = buildGitUri(uri);</span>
<span class="nc" id="L299">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L300">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="nc" id="L301">        } catch (final IOException e) {</span>
<span class="nc" id="L302">            throw new ConnectionException(e.getMessage(), e);</span>
<span class="fc" id="L303">        }</span>
<span class="fc" id="L304">    }</span>

    /**
     * If the destination directory is not inside the source directory (denoted
     * by starting with &quot;../&quot;), then another git repository is registered.
     * Warnings are suppressed for false positive with Sonar and multiple
     * exceptions on public API. {@inheritDoc}
     */
    @Override
    @SuppressWarnings(&quot;all&quot;)
    public void putDirectory(final File sourceDirectory,
            final String destinationDirectory) throws TransferFailedException,
            ResourceDoesNotExistException, AuthorizationException {
        try {
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">            if (!sourceDirectory.isDirectory()) {</span>
<span class="nc" id="L319">                throw new ResourceDoesNotExistException(format(</span>
                        R.getString(&quot;dirnotfound&quot;), sourceDirectory)); //$NON-NLS-1$
            }
<span class="fc" id="L322">            final File fileForResource = getFileForResource(destinationDirectory);</span>
<span class="fc" id="L323">            FileUtils.copyDirectoryStructure(sourceDirectory, fileForResource);</span>
<span class="fc" id="L324">        } catch (final IOException e) {</span>
<span class="fc" id="L325">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L326">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L327">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L328">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L329">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L330">        }</span>
<span class="fc" id="L331">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean resourceExists(final String resourceName)
            throws TransferFailedException {
        final File file;
        try {
<span class="fc" id="L341">            file = getFileForResource(resourceName);</span>
<span class="nc" id="L342">        } catch (final GitAPIException e) {</span>
<span class="nc" id="L343">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L344">        } catch (final IOException e) {</span>
<span class="nc" id="L345">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="nc" id="L346">        } catch (final URISyntaxException e) {</span>
<span class="nc" id="L347">            throw new TransferFailedException(e.getMessage(), e);</span>
<span class="fc" id="L348">        }</span>

<span class="pc bpc" id="L350" title="1 of 2 branches missed.">        if (resourceName.endsWith(&quot;/&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L351">            return file.isDirectory();</span>
        }

<span class="fc" id="L354">        return file.exists();</span>
    }

    /**
     * Directory copy is supported.
     *
     * @return true
     */
    @Override
    public boolean supportsDirectoryCopy() {
<span class="fc" id="L364">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>