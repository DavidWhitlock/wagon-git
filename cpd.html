<!DOCTYPE html>
<!-- Generated by Apache Maven Doxia Site Renderer 1.4 at 2014-04-23 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Git Wagon Provider - CPD Results</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20140423" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="page page-template-default full-width custom-background header-image singular customize-support">
    <div id="page" class="hfeed site">
    <div id="site-header">
                          <a href="http://www.trajano.net/" id="bannerLeft" title="Trajano">
                                        <img src="http://www.trajano.net/wp-content/uploads/2014/01/logo-blog-twentyfourteen1.png" alt="Trajano" />
                </a>
          </div>
    <header id="masthead" class="site-header" role="banner">
      <div class="header-main">
        <h1 class="site-title"><a href="http://site.trajano.net/wagon-git/wagon-git/" rel="home">Git Wagon Provider</a></h1>
        <nav id="primary-navigation" class="site-navigation primary-navigation" role="navigation">
          <ul class="nav-menu">
                  <li class="menu-item menu-item-type-post_type menu-item-object-page page_item">
                    <a href="http://site.trajano.net/trajano/" class="externalLink" title="Organizational POM">Organizational POM</a>
      </li>
      <li class="menu-item menu-item-type-post_type menu-item-object-page page_item">
                    <a href="http://site.trajano.net/coding-standards/" class="externalLink" title="Coding standards">Coding standards</a>
      </li>
      <li class="menu-item menu-item-type-post_type menu-item-object-page page_item">
                    <a href="http://site.trajano.net/commons-testing/" class="externalLink" title="Commons testing">Commons testing</a>
      </li>
      <li class="menu-item menu-item-type-post_type menu-item-object-page page_item">
                    <a href="http://site.trajano.net/java-archetype/" class="externalLink" title="Java archetype">Java archetype</a>
      </li>
      <li class="menu-item menu-item-type-post_type menu-item-object-page page_item">
                    <a href="http://www.trajano.net/open-source-projects/" class="externalLink" title="Other projects">Other projects</a>
      </li>
            </ul>
        </nav>
      </div>
    </header>
    <div id="main" class="site-main">
      <div id="main-content" class="main-content">
        <div id="primary" class="content-area">
	  <div id="content" class="site-content" role="main">
	    <article class="page type-page status-publish hentry">
	      <div class="entry-content">
                <div class="section">
<h2>CPD Results<a name="CPD_Results"></a></h2>
<p>The following document contains the results of PMD's  <a class="externalLink" href="http://pmd.sourceforge.net/cpd.html">CPD</a> 5.0.2.</p></div>
<div class="section">
<h2>Duplications<a name="Duplications"></a></h2>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>net\trajano\wagon\git\GitHubPagesWagon.java</td>
<td><a href="./xref/net/trajano/wagon/git/GitHubPagesWagon.html#41">41</a></td></tr>
<tr class="a">
<td>net\trajano\wagon\git\GitWagon.java</td>
<td><a href="./xref/net/trajano/wagon/git/GitWagon.html#43">43</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>public class GitHubPagesWagon extends StreamWagon {

    /**
     * Logger.
     */
    private static final Logger LOG;

    /**
     * Messages resource path.
     */
    private static final String MESSAGES = &quot;META-INF/Messages&quot;;

    /**
     * Resource bundle.
     */
    private static final ResourceBundle R;

    static {
        LOG = Logger.getLogger(&quot;net.trajano.wagon.git&quot;, MESSAGES);
        R = ResourceBundle.getBundle(MESSAGES);
    }

    /**
     * Credentials provider.
     */
    private CredentialsProvider credentialsProvider;

    /**
     * Git cache.
     */
    private final ConcurrentMap&lt;String, Git&gt; gitCache = new ConcurrentHashMap&lt;String, Git&gt;();

    /**
     * Git URI.
     */
    private GitUri gitUri;

    /**
     * This will commit the local changes and push them to the repository. If
     * the method is unable to push to the repository without force, it will
     * throw an exception. {@inheritDoc}
     */
    @Override
    public void closeConnection() throws ConnectionException {
        try {
            for (final String gitRemoteUri : gitCache.keySet()) {
                final Git git = gitCache.get(gitRemoteUri);
                git.add().addFilepattern(&quot;.&quot;).call(); //$NON-NLS-1$
                git.commit().setMessage(R.getString(&quot;commitmessage&quot;)).call(); //$NON-NLS-1$
                git.push().setRemote(gitRemoteUri)
                        .setCredentialsProvider(credentialsProvider).call();
                git.close();
                FileUtils.deleteDirectory(git.getRepository().getDirectory());
            }
        } catch (final GitAPIException e) {
            throw new ConnectionException(e.getMessage(), e);
        } catch (final IOException e) {
            throw new ConnectionException(e.getMessage(), e);
        }
    }

    /**
     * This will read from the working copy. File modification date would not be
     * available as it does not really have any meaningful value. {@inheritDoc}
     *
     * @throws ResourceDoesNotExistException
     *             when the file does not exist
     * @throws AuthorizationException
     *             when the file cannot be read
     */
    @Override
    public void fillInputData(final InputData inputData)
            throws TransferFailedException, ResourceDoesNotExistException,
            AuthorizationException {
        try {
            final File file = getFileForResource(inputData.getResource()
                    .getName());
            if (!file.exists()) {
                throw new ResourceDoesNotExistException(format(
                        R.getString(&quot;filenotfound&quot;), file)); //$NON-NLS-1$
            }
            if (!file.canRead()) {
                throw new AuthorizationException(format(
                        R.getString(&quot;cannotreadfile&quot;), file)); //$NON-NLS-1$
            }
            inputData.setInputStream(new FileInputStream(file));
            inputData.getResource().setContentLength(file.length());
        } catch (final IOException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final GitAPIException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final URISyntaxException e) {
            throw new TransferFailedException(e.getMessage(), e);
        }
    }

    /**
     * This will write to the working copy. {@inheritDoc}
     */
    @Override
    public void fillOutputData(final OutputData outputData)
            throws TransferFailedException {
        try {
            final File file = getFileForResource(outputData.getResource()
                    .getName());
            if (!file.getParentFile().mkdirs()
                    &amp;&amp; !file.getParentFile().exists()) {
                throw new TransferFailedException(format(
                        R.getString(&quot;unabletocreatedirs&quot;), //$NON-NLS-1$
                        file.getParentFile()));
            }
            outputData.setOutputStream(new FileOutputStream(file));
        } catch (final IOException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final GitAPIException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final URISyntaxException e) {
            throw new TransferFailedException(e.getMessage(), e);
        }
    }

    /**
     * This will get the file object for the given resource relative to the
     * {@link Git} specified for the connection. It will handle resources where
     * it jumps up past the parent folder.
     *
     * @param resourceName
     *            resource name.
     * @return file used for the resource.
     * @throws IOException
     * @throws GitAPIException
     *             problem with the GIT API.
     * @throws URISyntaxException
     */
    private File getFileForResource(final String resourceName)
            throws GitAPIException, IOException, URISyntaxException {
        // /foo/bar/foo.git + ../bar.git == /foo/bar/bar.git + /
        // /foo/bar/foo.git + ../bar.git/abc == /foo/bar/bar.git + /abc
        final GitUri resolved = gitUri.resolve(resourceName);
        final Git resourceGit = getGit(resolved.getGitRepositoryUri());
        return new File(resourceGit.getRepository().getWorkTree(),
                resolved.getResource());
    }

    /**
     * {@inheritDoc}
     * &lt;p&gt;
     * Warnings are suppressed for false positive with Sonar and multiple
     * exceptions on public API. {@inheritDoc}
     * &lt;/p&gt;
     */
    @Override
    @SuppressWarnings(&quot;all&quot;)
    public List&lt;String&gt; getFileList(final String directory)
            throws TransferFailedException, ResourceDoesNotExistException,
            AuthorizationException {
        final File dir;
        try {
            dir = getFileForResource(directory);
        } catch (final GitAPIException e) {
            throw new AuthorizationException(e.getMessage(), e);
        } catch (final IOException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final URISyntaxException e) {
            throw new ResourceDoesNotExistException(e.getMessage(), e);
        }
        final File[] files = dir.listFiles();
        if (files == null) {
            throw new ResourceDoesNotExistException(format(
                    R.getString(&quot;dirnotfound&quot;), dir)); //$NON-NLS-1$
        }
        final List&lt;String&gt; list = new LinkedList&lt;String&gt;();
        for (final File file : files) {
            String name = file.getName();
            if (file.isDirectory() &amp;&amp; !name.endsWith(&quot;/&quot;)) { //$NON-NLS-1$
                name += &quot;/&quot;; // NOPMD this is easier to read. //$NON-NLS-1$
            }
            list.add(name);
        }
        return list;
    }

    /**
     * This will create or refresh the working copy. If the working copy cannot
     * be pulled cleanly this method will fail.
     *
     * @param gitRepositoryUri
     *            remote git repository URI string
     * @return git
     * @throws GitAPIException
     * @throws IOException
     * @throws URISyntaxException
     */
    private Git getGit(final String gitRepositoryUri) throws GitAPIException,
            IOException, URISyntaxException {
        final Git cachedGit = gitCache.get(gitRepositoryUri);
        if (cachedGit != null) {
            return cachedGit;
        }
        final File gitDir = File.createTempFile(
                gitRepositoryUri.replaceAll(&quot;[^A-Za-z]&quot;, &quot;_&quot;), &quot;wagon-git&quot;); //$NON-NLS-1$
        gitDir.delete();
        gitDir.mkdir();

        if (getAuthenticationInfo().getUserName() != null) {
            credentialsProvider = new UsernamePasswordCredentialsProvider(
                    getAuthenticationInfo().getUserName(),
                    getAuthenticationInfo().getPassword() == null ? &quot;&quot; //$NON-NLS-1$
                            : getAuthenticationInfo().getPassword());
        } else {
            credentialsProvider = new PassphraseCredentialsProvider(
                    getAuthenticationInfo().getPassword());
        }
        final Git git = Git.cloneRepository().setURI(gitRepositoryUri)
                .setCredentialsProvider(credentialsProvider)
                .setBranch(gitUri.getBranchName()).setDirectory(gitDir).call();
        if (!gitUri.getBranchName().equals(git.getRepository().getBranch())) {
            LOG.log(Level.INFO, &quot;missingbranch&quot;, gitUri.getBranchName());
            final RefUpdate refUpdate = git.getRepository().getRefDatabase()
                    .newUpdate(Constants.HEAD, true);
            refUpdate.setForceUpdate(true);
            refUpdate.link(&quot;refs/heads/&quot; + gitUri.getBranchName()); //$NON-NLS-1$
        }
        gitCache.put(gitRepositoryUri, git);
        return git;
    }

    /**
     * Sets the initial git URI.
     */
    @Override
    protected void openConnectionInternal() throws ConnectionException,
            AuthenticationException {
        try {
            gitUri = GitUri.buildFromGithubPages(getRepository().getUrl());</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>net\trajano\wagon\git\GitHubPagesWagon.java</td>
<td><a href="./xref/net/trajano/wagon/git/GitHubPagesWagon.html#277">277</a></td></tr>
<tr class="a">
<td>net\trajano\wagon\git\GitWagon.java</td>
<td><a href="./xref/net/trajano/wagon/git/GitWagon.html#279">279</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            throw new ConnectionException(e.getMessage());
        }
    }

    /**
     * If the destination directory is not inside the source directory (denoted
     * by starting with &quot;../&quot;), then another git repository is registered.
     * Warnings are suppressed for false positive with Sonar and multiple
     * exceptions on public API. {@inheritDoc}
     */
    @Override
    @SuppressWarnings(&quot;all&quot;)
    public void putDirectory(final File sourceDirectory,
            final String destinationDirectory) throws TransferFailedException,
            ResourceDoesNotExistException, AuthorizationException {
        try {
            if (!sourceDirectory.isDirectory()) {
                throw new ResourceDoesNotExistException(format(
                        R.getString(&quot;dirnotfound&quot;), sourceDirectory)); //$NON-NLS-1$
            }
            final File fileForResource = getFileForResource(destinationDirectory);
            FileUtils.copyDirectoryStructure(sourceDirectory, fileForResource);
        } catch (final IOException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final GitAPIException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final URISyntaxException e) {
            throw new TransferFailedException(e.getMessage(), e);
        }
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean resourceExists(final String resourceName)
            throws TransferFailedException {
        final File file;
        try {
            file = getFileForResource(resourceName);
        } catch (final GitAPIException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final IOException e) {
            throw new TransferFailedException(e.getMessage(), e);
        } catch (final URISyntaxException e) {
            throw new TransferFailedException(e.getMessage(), e);
        }

        if (resourceName.endsWith(&quot;/&quot;)) { //$NON-NLS-1$
            return file.isDirectory();
        }

        return file.exists();
    }

    /**
     * Directory copy is supported.
     *
     * @return true
     */
    @Override
    public boolean supportsDirectoryCopy() {
        return true;
    }
}</pre></div></td></tr></table></div>
	      </div>
	    </article>
	  </div>
        </div>
      </div>
      <div id="secondary">
        <h2 class="site-description">
                
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2014-04-23</span>
                   <br /> <span id="projectVersion">Version: 2.0.0-SNAPSHOT</span>
                      </div>
      	</h2>
        <div id="primary-sidebar" class="primary-sidebar widget-area" role="complementary">
                <aside class="widget">
            </aside>
      <aside class="widget">
                 <h1 class="widget-title">Parent Project</h1>
                  <ul>
                  <li class="none">
                          <a href="http://site.trajano.net/trajano/index.html" class="externalLink" title="Trajano">Trajano</a>
            </li>
          </ul>
        </aside>
      <aside class="widget">
            </aside>
      <aside class="widget">
                 <h1 class="widget-title">Project Documentation</h1>
                  <ul>
                                                                                                                                                                                                                                                                                            <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                                                                                                                                                                                                    <li class="expanded">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                    <ul>
                      <li class="none">
                          <a href="dependency-updates-report.html" title="Dependency Updates Report">Dependency Updates Report</a>
            </li>
                      <li class="none">
                          <a href="plugin-updates-report.html" title="Plugin Updates Report">Plugin Updates Report</a>
            </li>
                      <li class="none">
                          <a href="checkstyle.html" title="Checkstyle">Checkstyle</a>
            </li>
                      <li class="none">
                          <a href="apidocs/index.html" title="JavaDocs">JavaDocs</a>
            </li>
                      <li class="none">
                          <a href="testapidocs/index.html" title="Test JavaDocs">Test JavaDocs</a>
            </li>
                      <li class="none">
                          <a href="xref/index.html" title="Source Xref">Source Xref</a>
            </li>
                      <li class="none">
                          <a href="xref-test/index.html" title="Test Source Xref">Test Source Xref</a>
            </li>
                      <li class="none">
            <strong>CPD Report</strong>
          </li>
                      <li class="none">
                          <a href="pmd.html" title="PMD Report">PMD Report</a>
            </li>
                      <li class="none">
                          <a href="surefire-report.html" title="Surefire Report">Surefire Report</a>
            </li>
                      <li class="none">
                          <a href="findbugs.html" title="FindBugs Report">FindBugs Report</a>
            </li>
                      <li class="none">
                          <a href="jacoco/index.html" title="JaCoCo Test">JaCoCo Test</a>
            </li>
              </ul>
        </li>
          </ul>
        </aside>
          </div>
      </div>
    </div>
    <footer id="colophon" class="site-footer" role="contentinfo">
      <div class="site-info">
                  Copyright &#169;                    2012&#x2013;2014
                        <a href="http://www.trajano.net/">Trajano</a>.
            All rights reserved.      
                    
                    </div>
    </footer>
    </div>
  </body>
</html>

